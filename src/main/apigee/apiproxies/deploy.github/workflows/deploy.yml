name: Deploy to Apigee

on:
  workflow_dispatch:  # allows the “Run Workflow” button

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Apigee CLI
        run: |
          curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh -
          sudo mv apigeecli /usr/local/bin/

      - name: Deploy all proxies
        run: |
          echo "Deploying all proxies..."

          for proxy in src/main/apigee/apiproxies/*; do
            echo "Deploying $(basename "$proxy")"
            apigeecli apis import \
              --org "$APIGEE_ORG" \
              --proxy "$(basename "$proxy")" \
              --file "$proxy" \
              --token "$APIGEE_TOKEN"

            apigeecli apis deploy \
              --org "$APIGEE_ORG" \
              --env "$APIGEE_ENV" \
              --name "$(basename "$proxy")" \
              --rev latest \
              --token "$APIGEE_TOKEN"
          done

env:
  APIGEE_ORG: ${{ secrets.APIGEE_ORG }}
  APIGEE_ENV: ${{ secrets.APIGEE_ENV }}
  APIGEE_TOKEN: ${{ secrets.APIGEE_TOKEN }}
