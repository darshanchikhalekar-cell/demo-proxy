name: Deploy to Apigee

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Authenticate using Service Account JSON
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # Install apigeecli
    - name: Install apigeecli
      run: |
        curl -L https://raw.githubusercontent.com/apigee/apigeecli/main/downloadLatest.sh | sh -
        export PATH=$PATH:$HOME/.apigeecli/bin
        echo "$HOME/.apigeecli/bin" >> $GITHUB_PATH

    # Save SA key to a file because apigeecli needs a file
    - name: Save Service Account Key
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > sa.json

    # Deploy ALL proxies inside repo
    - name: Deploy all proxies
      run: |
        export PATH=$PATH:$HOME/.apigeecli/bin

        for proxy in $(ls -d */ | cut -f1 -d'/'); do
          if [ -d "$proxy/apiproxy" ]; then
            echo "ðŸš€ Deploying $proxy ..."

            apigeecli apis create bundle \
              --org "${{ secrets.APIGEE_ORG }}" \
              --env "${{ secrets.APIGEE_ENV }}" \
              --name "$proxy" \
              --proxy-folder "./$proxy/apiproxy" \
              --safedeploy \
              --ovr \
              --account ./sa.json

            echo "âœ… Successfully deployed $proxy"
          fi
        done
